@page "/basket"
@inject IBasketService BasketService
@inject UserStateService UserStateService
@inject BasketStateService BasketStateService
@inject NavigationManager Navigation

<PageTitle>Sepetim</PageTitle>

<RadzenStack Gap="1.5rem">
    <RadzenHeading Size="HeadingSize.H1" Text="Sepetim" />

    @if (basket == null)
    {
        <RadzenStack AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Center" Style="min-height: 200px;">
            <RadzenProgressBarCircular ShowValue="false" Size="ProgressBarCircularSize.Large" />
        </RadzenStack>
    }
    else if (!basket.Items.Any())
    {
        <RadzenAlert AlertStyle="AlertStyle.Info" Title="Sepetiniz boş">
            <ChildContent>
                <RadzenLink Path="/" Text="Alışverişe başlamak için tıklayın" />
            </ChildContent>
        </RadzenAlert>
    }
    else
    {
        <RadzenRow Gap="1.5rem">
            <RadzenColumn Size="12" SizeMD="8">
                <RadzenStack Gap="1rem">
                    @foreach (var item in basket.Items)
                    {
                        <BasketItem Item="item" OnUpdate="UpdateBasket" OnRemove="RemoveItem" />
                    }
                </RadzenStack>
            </RadzenColumn>
            <RadzenColumn Size="12" SizeMD="4">
                <RadzenCard>
                    <RadzenStack Gap="1rem">
                        <RadzenHeading Size="HeadingSize.H5" Text="Sipariş Özeti" />
                        <RadzenStack Gap="0.5rem">
                            <RadzenStack Orientation="Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween">
                                <RadzenLabel Text="Ara Toplam:" />
                                <RadzenLabel Text="@((basket.TotalPrice + basket.Discount).ToString("C"))" Style="font-weight: 600;" />
                            </RadzenStack>
                            @if (basket.Discount > 0)
                            {
                                <RadzenStack Orientation="Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween">
                                    <RadzenLabel Text="İndirim:" Style="color: var(--rz-success);" />
                                    <RadzenLabel Style="font-weight: 600; color: var(--rz-success);">
                                        -@basket.Discount.ToString("C")
                                    </RadzenLabel>
                                </RadzenStack>
                            }
                            <hr style="margin: 0.5rem 0; border: none; border-top: 1px solid var(--rz-border-color);" />
                            <RadzenStack Orientation="Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween">
                                <RadzenLabel Text="Toplam:" Style="font-weight: 600;" />
                                <RadzenLabel Text="@basket.TotalPrice.ToString("C")" Style="font-size: 1.25rem; font-weight: 600; color: var(--rz-primary);" />
                            </RadzenStack>
                        </RadzenStack>
                        <RadzenButton Text="Ödemeye Geç" ButtonStyle="ButtonStyle.Primary" Size="ButtonSize.Large" Click="@NavigateToCheckout" Style="width: 100%;" />
                    </RadzenStack>
                </RadzenCard>
            </RadzenColumn>
        </RadzenRow>
    }
</RadzenStack>

@code {
    private ShoppingCartDto? basket;

    protected override async Task OnInitializedAsync()
    {
        await LoadBasket();
    }

    private async Task LoadBasket()
    {
        try
        {
            var userName = await UserStateService.GetUserNameAsync();
            basket = await BasketService.GetBasketAsync(userName);
            BasketStateService.UpdateItemCount(basket.Items.Sum(i => i.Quantity));
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading basket: {ex.Message}");
        }
    }

    private async Task UpdateBasket()
    {
        if (basket == null) return;

        try
        {
            // Backend sepeti kaydederken TotalPrice ve Discount'ı hesaplayacak
            var updatedBasket = await BasketService.StoreBasketAsync(basket);
            basket = updatedBasket; // Backend'den dönen discount'ı içeren basket'i kullan
            BasketStateService.UpdateItemCount(basket.Items.Sum(i => i.Quantity));
            StateHasChanged(); // UI'yi güncelle
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error updating basket: {ex.Message}");
        }
    }

    private async Task RemoveItem(ShoppingCartItemDto item)
    {
        if (basket == null) return;

        basket.Items.Remove(item);
        await UpdateBasket();
    }

    private void NavigateToCheckout()
    {
        Navigation.NavigateTo("/checkout");
    }
}

@using Web.UI.Models

