@page "/checkout"
@inject IBasketService BasketService
@inject UserStateService UserStateService
@inject BasketStateService BasketStateService
@inject NavigationManager Navigation
@inject NotificationService NotificationService

<PageTitle>Ödeme</PageTitle>

<RadzenStack Gap="1.5rem">
    <RadzenHeading Size="HeadingSize.H1" Text="Ödeme" />

    @if (basket == null)
    {
        <RadzenStack AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Center" Style="min-height: 200px;">
            <RadzenProgressBarCircular ShowValue="false" Size="ProgressBarCircularSize.Large" />
        </RadzenStack>
    }
    else if (!basket.Items.Any())
    {
        <RadzenAlert AlertStyle="AlertStyle.Warning" Title="Sepetiniz boş">
            <ChildContent>
                <RadzenLink Path="/" Text="Alışverişe başlamak için tıklayın" />
            </ChildContent>
        </RadzenAlert>
    }
    else
    {
        <RadzenRow Gap="1.5rem">
            <RadzenColumn Size="12" SizeMD="8">
                <RadzenStack Gap="1.5rem">
                    <RadzenCard>
                        <RadzenStack Gap="1rem">
                            <RadzenHeading Size="HeadingSize.H5" Text="Adres Bilgileri" />
                            <RadzenTemplateForm Data="@checkoutCommand">
                                <RadzenRow Gap="1rem">
                                    <RadzenColumn Size="12" SizeMD="6">
                                        <RadzenFormField Text="Ad" Required="true">
                                            <RadzenTextBox @bind-Value="@checkoutCommand.FirstName" Style="width: 100%;" />
                                        </RadzenFormField>
                                    </RadzenColumn>
                                    <RadzenColumn Size="12" SizeMD="6">
                                        <RadzenFormField Text="Soyad" Required="true">
                                            <RadzenTextBox @bind-Value="@checkoutCommand.LastName" Style="width: 100%;" />
                                        </RadzenFormField>
                                    </RadzenColumn>
                                </RadzenRow>
                                <RadzenFormField Text="E-posta" Required="true">
                                    <RadzenTextBox @bind-Value="@checkoutCommand.EmailAddress" Type="email" Style="width: 100%;" />
                                </RadzenFormField>
                                <RadzenFormField Text="Adres Satırı" Required="true">
                                    <RadzenTextBox @bind-Value="@checkoutCommand.AddressLine" Style="width: 100%;" />
                                </RadzenFormField>
                                <RadzenRow Gap="1rem">
                                    <RadzenColumn Size="12" SizeMD="4">
                                        <RadzenFormField Text="Ülke" Required="true">
                                            <RadzenTextBox @bind-Value="@checkoutCommand.Country" Style="width: 100%;" />
                                        </RadzenFormField>
                                    </RadzenColumn>
                                    <RadzenColumn Size="12" SizeMD="4">
                                        <RadzenFormField Text="Şehir" Required="true">
                                            <RadzenTextBox @bind-Value="@checkoutCommand.State" Style="width: 100%;" />
                                        </RadzenFormField>
                                    </RadzenColumn>
                                    <RadzenColumn Size="12" SizeMD="4">
                                        <RadzenFormField Text="Posta Kodu" Required="true">
                                            <RadzenTextBox @bind-Value="@checkoutCommand.ZipCode" Style="width: 100%;" />
                                        </RadzenFormField>
                                    </RadzenColumn>
                                </RadzenRow>
                            </RadzenTemplateForm>
                        </RadzenStack>
                    </RadzenCard>

                    <RadzenCard>
                        <RadzenStack Gap="1rem">
                            <RadzenHeading Size="HeadingSize.H5" Text="Ödeme Bilgileri" />
                            <RadzenTemplateForm Data="@checkoutCommand">
                                <RadzenFormField Text="Kart Üzerindeki İsim" Required="true">
                                    <RadzenTextBox @bind-Value="@checkoutCommand.CardName" Style="width: 100%;" />
                                </RadzenFormField>
                                <RadzenFormField Text="Kart Numarası" Required="true">
                                    <RadzenTextBox @bind-Value="@checkoutCommand.CardNumber" MaxLength="16" Style="width: 100%;" />
                                </RadzenFormField>
                                <RadzenRow Gap="1rem">
                                    <RadzenColumn Size="12" SizeMD="6">
                                        <RadzenFormField Text="Son Kullanma Tarihi (MM/YY)" Required="true">
                                            <RadzenTextBox @bind-Value="@checkoutCommand.Expiration" Placeholder="12/26" Style="width: 100%;" />
                                        </RadzenFormField>
                                    </RadzenColumn>
                                    <RadzenColumn Size="12" SizeMD="6">
                                        <RadzenFormField Text="CVV" Required="true">
                                            <RadzenTextBox @bind-Value="@checkoutCommand.CVV" MaxLength="3" Style="width: 100%;" />
                                        </RadzenFormField>
                                    </RadzenColumn>
                                </RadzenRow>
                                <RadzenFormField Text="Ödeme Yöntemi" Required="true">
                                    <RadzenDropDown @bind-Value="@checkoutCommand.PaymentMethod" Data="@paymentMethods" TextProperty="Text" ValueProperty="Value" Style="width: 100%;" />
                                </RadzenFormField>
                            </RadzenTemplateForm>
                        </RadzenStack>
                    </RadzenCard>
                </RadzenStack>
            </RadzenColumn>

            <RadzenColumn Size="12" SizeMD="4">
                <RadzenCard>
                    <RadzenStack Gap="1rem">
                        <RadzenHeading Size="HeadingSize.H5" Text="Sipariş Özeti" />
                        <RadzenStack Gap="0.5rem">
                            @foreach (var item in basket.Items)
                            {
                                <RadzenStack Orientation="Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween">
                                    <RadzenLabel Text="@($"{item.ProductName} x {item.Quantity}")" />
                                    <RadzenLabel Text="@((item.Price * item.Quantity).ToString("C"))" />
                                </RadzenStack>
                            }
                            <hr style="margin: 0.5rem 0; border: none; border-top: 1px solid var(--rz-border-color);" />
                            <RadzenStack Orientation="Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween">
                                <RadzenLabel Text="Ara Toplam:" />
                                <RadzenLabel Text="@basket.TotalPrice.ToString("C")" Style="font-weight: 600;" />
                            </RadzenStack>
                            @if (basket.Discount > 0)
                            {
                                <RadzenStack Orientation="Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween">
                                    <RadzenLabel Text="İndirim:" Style="color: var(--rz-success);" />
                                    <RadzenLabel Style="font-weight: 600; color: var(--rz-success);">
                                        -@basket.Discount.ToString("C")
                                    </RadzenLabel>
                                </RadzenStack>
                            }
                            <hr style="margin: 0.5rem 0; border: none; border-top: 1px solid var(--rz-border-color);" />
                            <RadzenStack Orientation="Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween">
                                <RadzenLabel Text="Toplam:" Style="font-weight: 600;" />
                                <RadzenLabel Text="@((basket.TotalPrice - basket.Discount).ToString("C"))" Style="font-size: 1.25rem; font-weight: 600; color: var(--rz-primary);" />
                            </RadzenStack>
                        </RadzenStack>
                        <RadzenButton Text="Siparişi Tamamla" ButtonStyle="ButtonStyle.Primary" Size="ButtonSize.Large" Click="@SubmitCheckout" Disabled="@isProcessing" Style="width: 100%;">
                            @if (isProcessing)
                            {
                                <RadzenProgressBarCircular ShowValue="false" Size="ProgressBarCircularSize.Small" Style="margin-right: 0.5rem;" />
                            }
                        </RadzenButton>
                    </RadzenStack>
                </RadzenCard>
            </RadzenColumn>
        </RadzenRow>
    }
</RadzenStack>

@code {
    private ShoppingCartDto? basket;
    private CheckoutBasketCommand checkoutCommand = new();
    private bool isProcessing = false;
    private List<PaymentMethodOption> paymentMethods = new()
    {
        new PaymentMethodOption { Value = 1, Text = "Kredi Kartı" },
        new PaymentMethodOption { Value = 2, Text = "Banka Kartı" }
    };

    private class PaymentMethodOption
    {
        public int Value { get; set; }
        public string Text { get; set; } = string.Empty;
    }

    protected override async Task OnInitializedAsync()
    {
        try
        {
            var userName = await UserStateService.GetUserNameAsync();
            basket = await BasketService.GetBasketAsync(userName);
            
            if (basket != null && basket.Items.Any())
            {
                checkoutCommand.UserName = userName;
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading basket: {ex.Message}");
        }
    }

    private async Task SubmitCheckout()
    {
        if (basket == null || !basket.Items.Any()) return;

        isProcessing = true;
        try
        {
            var result = await BasketService.CheckoutBasketAsync(checkoutCommand);
            if (result)
            {
                BasketStateService.Clear();
                NotificationService.Notify(new NotificationMessage 
                { 
                    Severity = NotificationSeverity.Success, 
                    Summary = "Sipariş Tamamlandı", 
                    Detail = "Siparişiniz başarıyla oluşturuldu", 
                    Duration = 4000 
                });
                Navigation.NavigateTo("/orders");
            }
            else
            {
                NotificationService.Notify(new NotificationMessage 
                { 
                    Severity = NotificationSeverity.Warning, 
                    Summary = "Uyarı", 
                    Detail = "Sipariş oluşturulamadı", 
                    Duration = 4000 
                });
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error during checkout: {ex.Message}");
            NotificationService.Notify(new NotificationMessage 
            { 
                Severity = NotificationSeverity.Error, 
                Summary = "Hata", 
                Detail = "Sipariş oluşturulurken bir hata oluştu", 
                Duration = 4000 
            });
        }
        finally
        {
            isProcessing = false;
        }
    }
}

@using Web.UI.Models

