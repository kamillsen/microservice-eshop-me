@page "/orders"
@inject IOrderingService OrderingService
@inject UserStateService UserStateService

<PageTitle>Siparişlerim</PageTitle>

<RadzenStack Gap="1.5rem">
    <RadzenHeading Size="HeadingSize.H1" Text="Siparişlerim" />

    @if (orders == null)
    {
        <RadzenStack AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Center" Style="min-height: 200px;">
            <RadzenProgressBarCircular ShowValue="false" Size="ProgressBarCircularSize.Large" />
        </RadzenStack>
    }
    else if (!orders.Any())
    {
        <RadzenAlert AlertStyle="AlertStyle.Info" Title="Henüz siparişiniz bulunmamaktadır">
            <ChildContent>
                <RadzenLink Path="/" Text="Alışverişe başlamak için tıklayın" />
            </ChildContent>
        </RadzenAlert>
    }
    else
    {
        <RadzenStack Gap="1rem">
            @foreach (var order in orders)
            {
                <RadzenCard>
                    <RadzenStack Gap="0.75rem">
                        <RadzenStack Orientation="Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween" AlignItems="AlignItems.Center">
                            <RadzenHeading Size="HeadingSize.H5" Text="@($"Sipariş #{order.Id.ToString().Substring(0, 8)}")" />
                            <RadzenLabel Text="@order.OrderDate.ToString("dd.MM.yyyy HH:mm")" Style="color: var(--rz-text-secondary-color);" />
                        </RadzenStack>
                        <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="0.5rem">
                            <RadzenLabel Text="Durum:" />
                            <RadzenBadge BadgeStyle="@GetStatusBadgeStyle(order.Status)" Text="@order.Status" />
                        </RadzenStack>
                        <RadzenStack Gap="0.25rem">
                            <RadzenStack Orientation="Orientation.Horizontal" Gap="0.5rem" AlignItems="AlignItems.Center">
                                <RadzenLabel Text="@($"{order.Items.Count} ürün")" Style="font-weight: 600;" />
                                <RadzenLabel Text="-" />
                                <RadzenLabel Text="Toplam:" Style="font-weight: 600;" />
                                <RadzenLabel Text="@((order.TotalPrice - order.Discount).ToString("C"))" Style="font-weight: 600; color: var(--rz-primary);" />
                                @if (order.Discount > 0)
                                {
                                    <RadzenLabel Text="@($"(İndirim: -{order.Discount.ToString("C")})")" Style="color: var(--rz-success);" />
                                }
                            </RadzenStack>
                            <RadzenLabel Text="@($"Ürünler: {string.Join(", ", order.Items.Select(i => $"{i.ProductName} x{i.Quantity}"))}")" Style="color: var(--rz-text-secondary-color); font-size: 0.875rem;" />
                        </RadzenStack>
                    </RadzenStack>
                </RadzenCard>
            }
        </RadzenStack>
    }
</RadzenStack>

@code {
    private List<OrderDto>? orders;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            var userName = await UserStateService.GetUserNameAsync();
            orders = (await OrderingService.GetOrdersByUserAsync(userName)).ToList();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading orders: {ex.Message}");
            orders = new List<OrderDto>();
        }
    }

    private BadgeStyle GetStatusBadgeStyle(string status)
    {
        return status.ToLower() switch
        {
            "pending" => BadgeStyle.Warning,
            "shipped" => BadgeStyle.Info,
            "delivered" => BadgeStyle.Success,
            "cancelled" => BadgeStyle.Danger,
            _ => BadgeStyle.Secondary
        };
    }
}

@using Web.UI.Models

