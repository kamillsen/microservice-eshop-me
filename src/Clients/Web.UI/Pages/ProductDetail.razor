@page "/product/{id:guid}"
@inject ICatalogService CatalogService
@inject IBasketService BasketService
@inject UserStateService UserStateService
@inject BasketStateService BasketStateService
@inject NavigationManager Navigation
@inject NotificationService NotificationService

<PageTitle>@(product?.Name ?? "Ürün Detayı")</PageTitle>

<RadzenStack Gap="1.5rem">
    @if (product == null)
    {
        <RadzenStack AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Center" Style="min-height: 400px;">
            <RadzenProgressBarCircular ShowValue="false" Size="ProgressBarCircularSize.Large" />
        </RadzenStack>
    }
    else
    {
        <RadzenRow Gap="2rem">
            <RadzenColumn Size="12" SizeMD="6">
                @if (!string.IsNullOrEmpty(product.ImageUrl))
                {
                    <RadzenImage Path="@product.ImageUrl" Alt="@product.Name" Style="width: 100%; max-height: 500px; object-fit: contain;" />
                }
                else
                {
                    <div style="width: 100%; height: 400px; background-color: var(--rz-base-300); display: flex; align-items: center; justify-content: center;">
                        <RadzenLabel Text="Resim Yok" Style="color: var(--rz-text-secondary-color);" />
                    </div>
                }
            </RadzenColumn>
            <RadzenColumn Size="12" SizeMD="6">
                <RadzenStack Gap="1rem">
                    <RadzenHeading Size="HeadingSize.H1" Text="@product.Name" />
                    <RadzenLabel Style="color: var(--rz-text-secondary-color);">
                        Kategori: @product.CategoryName
                    </RadzenLabel>
                    <RadzenHeading Size="HeadingSize.H3" Text="@product.Price.ToString("C")" Style="color: var(--rz-primary);" />
                    <RadzenLabel Text="@(product.Description ?? "Açıklama yok")" />
                    
                    <RadzenFormField Text="Miktar" Style="max-width: 200px;">
                        <RadzenNumeric @bind-Value="@quantity" Min="1" Style="width: 100%;" />
                    </RadzenFormField>
                    
                    <RadzenStack Orientation="Orientation.Horizontal" Gap="0.5rem">
                        <RadzenButton Text="@($"Sepete Ekle ({quantity} adet)")" ButtonStyle="ButtonStyle.Primary" Size="ButtonSize.Large" Click="@AddToBasket" />
                        <RadzenButton Text="Geri Dön" ButtonStyle="ButtonStyle.Secondary" Variant="Variant.Outlined" Size="ButtonSize.Large" Click="@(() => Navigation.NavigateTo("/"))" />
                    </RadzenStack>
                </RadzenStack>
            </RadzenColumn>
        </RadzenRow>
    }
</RadzenStack>

@code {
    [Parameter]
    public Guid Id { get; set; }

    private ProductDto? product;
    private int quantity = 1;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            product = await CatalogService.GetProductByIdAsync(Id);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading product: {ex.Message}");
        }
    }

    private async Task AddToBasket()
    {
        if (product == null) return;

        try
        {
            var userName = await UserStateService.GetUserNameAsync();
            var basket = await BasketService.GetBasketAsync(userName);

            var existingItem = basket.Items.FirstOrDefault(i => i.ProductId == product.Id);
            if (existingItem != null)
            {
                existingItem.Quantity += quantity;
            }
            else
            {
                basket.Items.Add(new ShoppingCartItemDto
                {
                    ProductId = product.Id,
                    ProductName = product.Name,
                    Quantity = quantity,
                    Price = product.Price
                });
            }

            // Backend sepeti kaydederken TotalPrice ve Discount'ı hesaplayacak
            basket = await BasketService.StoreBasketAsync(basket);
            BasketStateService.UpdateItemCount(basket.Items.Sum(i => i.Quantity));
            
            NotificationService.Notify(new NotificationMessage 
            { 
                Severity = NotificationSeverity.Success, 
                Summary = "Başarılı", 
                Detail = $"{product.Name} ({quantity} adet) sepete eklendi", 
                Duration = 3000 
            });
            
            Navigation.NavigateTo("/basket");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error adding to basket: {ex.Message}");
            NotificationService.Notify(new NotificationMessage 
            { 
                Severity = NotificationSeverity.Error, 
                Summary = "Hata", 
                Detail = "Ürün sepete eklenirken bir hata oluştu", 
                Duration = 4000 
            });
        }
    }
}

@using Web.UI.Models

